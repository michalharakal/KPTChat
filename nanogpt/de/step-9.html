<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Step 9. Transformers - MultiHeadAttention :: KPTChat</title>
    <link rel="canonical" href="https://michalharakal.github.io/KPTChat/nanogpt/de/step-9.html">
    <link rel="prev" href="step-8.html">
    <link rel="next" href="step-10.html">
    <meta name="generator" content="Antora 3.1.8">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://michalharakal.github.io/KPTChat">KPTChat</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="nanogpt" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">nanoGPT Explained</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Schritt nach Schritt</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-1.html">Step 1. Imports-Block</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-2.html">Step 2. Initialisierung-Block</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-3.html">Step 3. Daten laden</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-4.html">Step 4. Tokenisierung</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-5.html">Step 5. Train &amp; Test Spilt</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-6.html">Step 6. Batch &amp; Block</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-7.html">Step 7. estimate_loss()</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-8.html">Step 8. Transformers - Head</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="step-9.html">Step 9. Transformers - MultiHeadAttention</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-10.html">Step 10. Transformers - Feedforward</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="step-11.html">Step 11. Transformers - Block</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Addons</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#extra_save_params.adoc">extra_save_params.adoc</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">nanoGPT Explained</span>
    <span class="version">default</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../kgpt/index.html">KGPTChat</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../kgpt/index.html">default</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">nanoGPT Explained</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">default</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../kgpt/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">nanoGPT Explained</a></li>
    <li>Schritt nach Schritt</li>
    <li><a href="step-9.html">Step 9. Transformers - MultiHeadAttention</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Step 9. Transformers - MultiHeadAttention</h1>
<div id="preamble">
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">class MultiHeadAttention(nn.Module):
    """ multiple heads of self-attention in parallel """

    def __init__(self, num_heads, head_size):
        super().__init__()
        self.heads = nn.ModuleList([Head(head_size) for _ in range(num_heads)])
        self.proj = nn.Linear(head_size * num_heads, n_embd)
        self.dropout = nn.Dropout(dropout)

    def forward(self, x):
        out = torch.cat([h(x) for h in self.heads], dim=-1)
        out = self.dropout(self.proj(out))
        return out</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="code-erklären"><a class="anchor" href="#code-erklären"></a>Code erklären</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>MultiHeadAttention</code> als eine Pytorch <code>nn.Module</code> Klasse implementiert "Mutliheads" in self attention. Diese Klasse benutzt  keine globale Variable. Die Parameter <a href="terms.html#num_heads" class="xref page">num_heads</a> und <a href="terms.html#head_size" class="xref page">head_size</a> sind als construktor Parameter übergeben.</p>
</div>
<div class="paragraph">
<p>Die "Multiheads" sind zwar als <code>nn.ModuleList</code> erzeugt, aber die heads werden in parallel, nicht sequenziel ausgeführt. Vorteil vom nutzen der <code>nn.ModuleList</code> Klasse ist, dass das Auswerten von <code>-parametes()</code> automatisch für die Element erfolgt.</p>
</div>
<div class="paragraph">
<p>Die Inferenz ist aber in der <code>forward</code> Methode durch List Comprehension überschrieben und dadurch auch paralelsierbar.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="paralelle-ausführung"><a class="anchor" href="#paralelle-ausführung"></a>Paralelle Ausführung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Berechnung erfolgt in der Formulierung des Codes sequentiell für jeden Head, da die List Comprehension <code>[h(x) for h in self.heads]</code> durch die Heads iteriert und für jeden einzelnen das Ergebnis von h(x) berechnet, bevor zum nächsten übergegangen wird. Dies geschieht nacheinander für jeden Head in der Liste.</p>
</div>
<div class="paragraph">
<p>Obwohl die Berechnung im Code sequentiell erscheint, ist es wichtig zu beachten, dass moderne Deep Learning Frameworks wie <code>PyTorch</code> intern stark optimiert sind, um Berechnungen zu parallelisieren, insbesondere auf GPUs. Das bedeutet, dass während der Code sequentiell aussieht, die tatsächliche Ausführung auf der Hardwareebene je nach Situation und Hardwarekonfiguration parallelisiert werden kann. PyTorch und ähnliche Frameworks nutzen die parallele Natur von GPUs, um viele Operationen gleichzeitig auszuführen, was besonders bei größeren Modellen und Datenmengen zu erheblichen Leistungssteigerungen führt.</p>
</div>
<div class="paragraph">
<p>In der Praxis heißt das, dass selbst wenn der Code die Heads sequentiell abarbeitet, die eigentlichen Matrixoperationen innerhalb jedes Heads (z.B. Matrix-Multiplikationen) sehr effizient und möglicherweise parallel auf der Hardware ausgeführt werden können.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="step-8.html">Step 8. Transformers - Head</a></span>
  <span class="next"><a href="step-10.html">Step 10. Transformers - Feedforward</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
